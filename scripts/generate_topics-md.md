# generate_topics.py 脚本说明

## 概述

`generate_topics.py` 是一个用于从股票 Markdown 文件中提取题材信息并生成题材索引文件的脚本。它会自动扫描 `stocks` 目录下的所有股票文件，提取题材和附带题材信息，然后在 `topics-mds` 目录下生成对应的索引文件。

## 功能

1. **解析股票文件**：从股票 Markdown 文件中提取主题材和附带题材
2. **生成主题材文件**：为每个主题材生成索引文件，包含所有相关股票
3. **生成附带题材文件**：为每个附带题材生成索引文件，包含相关主题材和股票
4. **建立链接关系**：在生成的文件中建立相互链接，方便导航

## 输入文件格式

### 股票文件结构

股票文件位于 `stocks` 目录下的各个子目录中，文件格式如下：

```markdown
# 股票名称

## 题材

### 主题材名称1

- 附带题材1
- 附带题材2

主题材的注释内容（可选）

### 主题材名称2

- 附带题材3

主题材的注释内容（可选）
```

**格式说明：**
- 一级标题（`#`）：股票名称
- 二级标题（`## 题材`）：题材部分标识
- 三级标题（`### 主题材名称`）：主题材名称
- 列表项（`- 附带题材`）：该主题材的附带题材
- 普通文本：主题材的注释（可选，脚本会忽略）

**示例：**

```markdown
# SH.主.002321-华英农业

## 题材

### 羽绒

- 冬季
- 寒潮

羽绒利润常年占总利润的 60% 上下
```

## 输出文件结构

脚本会在 `topics-mds` 目录下生成两个子目录：

### 1. `topics-mds/主题材/` 目录

为每个主题材生成一个 Markdown 文件，文件名为主题材名称。

**文件内容：**
- **股票列表**：包含该主题材的所有股票（带链接，指向股票文件中的对应三级标题）
- **附带题材**：显示所有出现过的附带题材（并集，带链接）

**示例：`topics-mds/主题材/羽绒.md`**

```markdown
# 羽绒

## 股票列表

- [SH.主.002321-华英农业](../../stocks/上交所/主板/SH.主.002321-华英农业.md#羽绒)
- [SH.主.002322-测试股票](../../stocks/上交所/主板/SH.主.002322-测试股票.md#羽绒)

## 附带题材

- [冬季](../附带题材/冬季.md)
- [寒潮](../附带题材/寒潮.md)
```

### 2. `topics-mds/附带题材/` 目录

为每个附带题材生成一个 Markdown 文件，文件名为附带题材名称。

**文件内容：**
- **相关主题材**：包含该附带题材的所有主题材（带链接）
- **相关股票**：包含该附带题材的所有股票（带链接）

**示例：`topics-mds/附带题材/冬季.md`**

```markdown
# 冬季

## 相关主题材

- [羽绒](../主题材/羽绒.md)

## 相关股票

- [SH.主.002321-华英农业](../../stocks/上交所/主板/SH.主.002321-华英农业.md#题材)
- [SH.主.002322-测试股票](../../stocks/上交所/主板/SH.主.002322-测试股票.md#题材)
```

## 工作流程

### 1. 解析阶段（`parse_markdown_file`）

- 读取股票 Markdown 文件
- 提取股票名称（一级标题）
- 解析 `## 题材` 部分：
  - 识别三级标题（`### 主题材名称`）作为主题材
  - 识别列表项（`- 附带题材`）作为附带题材
  - 忽略注释内容

### 2. 收集阶段（`collect_all_topics`）

遍历所有股票文件，收集以下信息：

- **主题材信息**：
  - 每个主题材对应的所有股票
  - 每个股票对应的附带题材集合
  - 计算所有出现过的附带题材（并集）

- **附带题材映射**：
  - 每个附带题材对应的主题材集合
  - 每个附带题材对应的股票集合

- **路径映射**：
  - 股票名称到文件路径的映射（用于生成链接）

### 3. 生成阶段（`generate_topic_files`）

#### 3.1 生成主题材文件（`generate_main_topic_file`）

- 为每个主题材创建文件
- 列出所有包含该主题材的股票（带链接，指向股票文件中的对应三级标题）
- 列出所有出现过的附带题材（并集，带链接到附带题材文件）

**并集逻辑说明：**
- 如果 3 个股票中，1 个有"冬季"，1 个有"寒潮"，则两个都会显示
- 使用并集（union）而非交集（intersection）

#### 3.2 生成附带题材文件（`generate_attached_topic_file`）

- 为每个附带题材创建文件
- 列出所有包含该附带题材的主题材（带链接）
- 列出所有包含该附带题材的股票（带链接）

## 关键算法

### 附带题材的并集计算

```python
# 计算所有出现过的附带题材（并集）
all_attached = set()
for stock, attached_set in main_topics[topic]['stock_attached'].items():
    all_attached.update(attached_set)

main_topics[topic]['attached'] = sorted(list(all_attached))
```

**说明：**
- 使用 `set` 数据结构自动去重
- 使用 `update` 方法合并所有股票的附带题材集合
- 最终结果按字母顺序排序

### 链接生成

**股票链接：**
- 从 `topics-mds/主题材/` 到 `stocks/...` 的相对路径：`../../stocks/...`
- 锚点指向三级标题：`#主题材名称`

**附带题材链接：**
- 从 `topics-mds/主题材/` 到 `topics-mds/附带题材/` 的相对路径：`../附带题材/...`
- 从 `topics-mds/附带题材/` 到 `topics-mds/主题材/` 的相对路径：`../主题材/...`

## 使用方法

### 基本用法

```bash
python3 scripts/generate_topics.py
```

### 输出示例

```
开始收集题材信息...
找到 1 个主题材
找到 2 个附带题材

开始生成题材文件...
生成主题材文件: topics-mds/主题材/羽绒.md (包含 1 个股票)
生成附带题材文件: topics-mds/附带题材/冬季.md (链接到 1 个主题材, 1 个股票)
生成附带题材文件: topics-mds/附带题材/寒潮.md (链接到 1 个主题材, 1 个股票)

完成！所有文件已生成到 topics-mds 目录
```

## 数据结构

### 主题材信息结构

```python
{
    'stocks': ['股票1', '股票2', ...],  # 包含该主题材的所有股票
    'comment': '注释内容',              # 注释（已废弃，不再使用）
    'attached': ['附带题材1', '附带题材2', ...],  # 所有出现过的附带题材（并集）
    'stock_attached': {                 # 每个股票对应的附带题材
        '股票1': {'附带题材1', '附带题材2'},
        '股票2': {'附带题材3'},
        ...
    }
}
```

### 附带题材映射结构

```python
{
    '附带题材名': {
        '主题材集合': {'主题材1', '主题材2', ...},
        '股票集合': {'股票1', '股票2', ...}
    }
}
```

## 注意事项

1. **文件路径**：脚本会自动处理相对路径，确保生成的链接正确
2. **去重处理**：股票和附带题材会自动去重
3. **排序**：所有列表按字母顺序排序，确保输出一致性
4. **编码**：所有文件使用 UTF-8 编码
5. **错误处理**：如果某个文件解析失败，会输出警告但继续处理其他文件

## 扩展说明

### 支持多个主题材

一个股票文件可以包含多个主题材，每个主题材可以有多个附带题材：

```markdown
## 题材

### 主题材1
- 附带题材1
- 附带题材2

### 主题材2
- 附带题材3
```

### 支持多个股票

多个股票可以共享同一个主题材，脚本会自动收集所有相关股票：

- 股票A：羽绒 + 冬季
- 股票B：羽绒 + 寒潮
- 股票C：羽绒 + 冬季 + 寒潮

结果：
- `羽绒.md` 会列出所有 3 个股票
- `羽绒.md` 的附带题材部分会显示"冬季"和"寒潮"（并集）
- `冬季.md` 会显示股票A和股票C
- `寒潮.md` 会显示股票B和股票C

## 维护

- 脚本位置：`scripts/generate_topics.py`
- 输出目录：`topics-mds/`
- 输入目录：`stocks/`

每次修改股票文件后，运行脚本即可更新题材索引文件。

